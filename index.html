<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão - Fazenda de Mandioca</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC6MybSwXWQgzHmkkKIJ37h-8QEQh3kSK4",
            authDomain: "fzmeuparaiso.firebaseapp.com",
            projectId: "fzmeuparaiso",
            storageBucket: "fzmeuparaiso.firebasestorage.app",
            messagingSenderId: "425623716607",
            appId: "1:425623716607:web:8f318f0dc77df4fccb82ca",
            measurementId: "G-EGCP5KB3KW"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseAuth = { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged };
        window.firestore = { doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc };
    </script>

    <style>
        @media print {
            body {
                font-size: 12px;
            }

            .no-print {
                display: none;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
        }

        input[readonly] {
            background-color: #f9f9f9;
        }

        .editable {
            background-color: #fef3c7 !important;
        }

        .positive {
            color: #059669;
        }

        .negative {
            color: #dc2626;
        }

        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
        }

        .login-box {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .main-system {
            display: none;
        }

        .main-system.authenticated {
            display: block;
        }

        .logo-container {
            max-width: 120px;
            max-height: 80px;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }

            .overflow-x-auto {
                font-size: 0.875rem;
            }

            .chart-container {
                height: 250px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10B981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- Indicador de salvamento -->
    <div id="saveIndicator" class="save-indicator">
        <i class="fas fa-check mr-2"></i>Dados salvos automaticamente
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container flex items-center justify-center p-4">
        <div class="login-box max-w-md w-full p-8 rounded-2xl shadow-2xl border border-white/20">
            <div class="text-center mb-8">
                <div class="logo-container mx-auto mb-4">
                    <img src="https://i.postimg.cc/Y0cB4Km2/Chat-GPT-Image-11-08-2025-13-05-16.png" alt="Logo Fazenda"
                        class="mx-auto">
                </div>
                <h1 style="margin-top: 55px;" class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-seedling text-green-600 mr-2"></i>
                    Fazenda Meu Paraíso
                </h1>
                <p class="text-gray-600">Sistema de Gestão Integrado</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <div class="relative">
                            <input type="email" id="email" required
                                class="w-full p-4 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                                placeholder="Digite seu email">
                            <i
                                class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <div class="relative">
                            <input type="password" id="password" required
                                class="w-full p-4 pl-12 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                                placeholder="Digite sua senha">
                            <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button type="button" onclick="togglePassword()"
                                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="loginUser()" id="loginBtn"
                            class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg font-medium hover:from-green-600 hover:to-green-700 transform hover:scale-105 transition duration-200 shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Entrar
                        </button>
                        <button onclick="registerUser()" id="registerBtn"
                            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg font-medium hover:from-blue-600 hover:to-blue-700 transform hover:scale-105 transition duration-200 shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>
                            Cadastrar
                        </button>
                    </div>
                </div>
            </div>

            <div id="authMessage" class="hidden mt-4 p-4 rounded-lg text-center"></div>

            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Sistema de Gestão - Fazenda de Mandioca</p>
                <p>Controle Completo para Atingir a Meta de R$ 1.000.000</p>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="main-system container mx-auto p-2 md:p-4 max-w-7xl">
        <!-- Header -->
        <div class="bg-green-800 text-white p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex flex-col md:flex-row items-center mb-4 md:mb-0">
                    <div class="logo-container mb-2 md:mb-0 md:mr-4">
                        <img src="https://i.postimg.cc/Y0cB4Km2/Chat-GPT-Image-11-08-2025-13-05-16.png"
                            alt="Logo Fazenda" class="rounded-lg">
                    </div>
                    <div class="text-center md:text-left">
                        <h1 class="text-xl md:text-3xl font-bold flex items-center justify-center md:justify-start">
                            <i class="fas fa-seedling mr-2 md:mr-3"></i>
                            Sistema de Gestão - Fazenda Meu Paraíso
                        </h1>
                        <p class="text-green-200 mt-1 md:mt-2 text-sm md:text-base">Controle Completo para Atingir a
                            Meta de R$ 1.000.000</p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <div class="flex flex-col md:flex-row items-center mb-2">
                        <span class="text-sm mr-0 md:mr-3 mb-2 md:mb-0">Usuário: <strong
                                id="currentUser"></strong></span>
                        <button onclick="logoutUser()"
                            class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition duration-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Sair
                        </button>
                    </div>

                    <div class="bg-yellow-400 h-3 rounded-full" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-sm mb-4 md:mb-6">
        <div class="flex flex-wrap border-b overflow-x-auto">
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 active text-sm md:text-base"
                data-tab="propriedade">
                <i class="fas fa-home mr-1 md:mr-2"></i><span class="hidden sm:inline">Dados da </span>Propriedade
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="investimentos">
                <i class="fas fa-money-bill-wave mr-1 md:mr-2"></i>Investimentos
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="producao">
                <i class="fas fa-seedling mr-1 md:mr-2"></i>Produção
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="estoque">
                <i class="fas fa-boxes mr-1 md:mr-2"></i>Estoque
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="pessoas">
                <i class="fas fa-users mr-1 md:mr-2"></i>Pessoas
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="vendas">
                <i class="fas fa-shopping-cart mr-1 md:mr-2"></i>Vendas
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="dashboard">
                <i class="fas fa-chart-line mr-1 md:mr-2"></i>Dashboard
            </button>
            <button
                class="tab-btn px-3 md:px-6 py-2 md:py-3 font-medium text-gray-600 border-b-2 border-transparent hover:text-green-600 hover:border-green-600 text-sm md:text-base"
                data-tab="projecoes">
                <i class="fas fa-crystal-ball mr-1 md:mr-2"></i>Projeções
            </button>
        </div>
    </div>

    <!-- Tab Contents -->

    <!-- 1. Dados da Propriedade -->
    <div id="propriedade" class="tab-content active bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-home text-green-600 mr-2 md:mr-3"></i>Dados da Propriedade
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <!-- Informações Gerais -->
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4 bg-green-100 p-3 rounded">
                    <i class="fas fa-info-circle mr-2"></i>Informações Gerais
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Nome da Propriedade</label>
                        <input type="text" id="nomePropriedade" class="w-full p-3 border rounded-lg editable"
                            placeholder="Ex: Fazenda São João">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Área (hectares)</label>
                            <input type="number" id="areaHa" class="w-full p-3 border rounded-lg editable"
                                placeholder="0" onchange="calcularArea()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Área (m²)</label>
                            <input type="number" id="areaM2" class="w-full p-3 border rounded-lg bg-gray-100" readonly>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Localização</label>
                        <input type="text" id="localizacao" class="w-full p-3 border rounded-lg editable"
                            placeholder="Cidade, Estado">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Valor Estimado da Terra
                            (R$)</label>
                        <input type="number" id="valorTerra" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                </div>
            </div>

            <!-- Custos Iniciais -->
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4 bg-yellow-100 p-3 rounded">
                    <i class="fas fa-calculator mr-2"></i>Custos Iniciais Detalhados
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Limpeza do Terreno (R$)</label>
                        <input type="number" id="limpezaTerreno" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Insumos Agrícolas (R$)</label>
                        <input type="number" id="insumosAgricolas" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Ferramentas e Maquinário
                            (R$)</label>
                        <input type="number" id="ferramentasMaquinario" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Infraestrutura (R$)</label>
                        <input type="number" id="infraestrutura" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Mão de Obra Inicial (R$)</label>
                        <input type="number" id="maoObraInicial" class="w-full p-3 border rounded-lg editable"
                            placeholder="0,00" onchange="calcularInvestimentoTotal()">
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <label class="block text-lg font-bold text-green-800 mb-1">Total de Investimento
                            Inicial</label>
                        <div class="text-2xl font-bold text-green-600" id="totalInvestimento">R$ 0,00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Investimentos -->
    <div id="investimentos" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-money-bill-wave text-green-600 mr-2 md:mr-3"></i>Investimentos - Fluxo de Caixa
        </h2>

        <!-- Formulário de Adicionar Investimento -->
        <div class="bg-blue-50 p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <h3 class="text-base md:text-lg font-semibold text-blue-800 mb-4">Adicionar Novo Investimento</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                    <input type="date" id="dataInvestimento" class="w-full p-2 border rounded-lg editable">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Descrição</label>
                    <input type="text" id="descricaoInvestimento" class="w-full p-2 border rounded-lg editable"
                        placeholder="Descrição do gasto">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Categoria</label>
                    <select id="categoriaInvestimento" class="w-full p-2 border rounded-lg editable">
                        <option value="insumos">Insumos</option>
                        <option value="equipamentos">Equipamentos</option>
                        <option value="manutencao">Manutenção</option>
                        <option value="transporte">Transporte</option>
                        <option value="mao_obra">Mão de Obra</option>
                        <option value="impostos">Impostos</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label>
                    <input type="number" id="valorInvestimento" class="w-full p-2 border rounded-lg editable"
                        placeholder="0,00">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tipo</label>
                    <select id="tipoInvestimento" class="w-full p-2 border rounded-lg editable">
                        <option value="fixo">Fixo</option>
                        <option value="variavel">Variável</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Safra</label>
                    <input type="text" id="safraInvestimento" class="w-full p-2 border rounded-lg editable"
                        placeholder="Ex: 2024/1">
                </div>
                <div class="flex items-end">
                    <button onclick="adicionarInvestimento()"
                        class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Investimentos -->
        <div class="overflow-x-auto mb-6">
            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Data</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Descrição</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Categoria</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Valor</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Tipo</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Safra</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaInvestimentos"></tbody>
            </table>
        </div>

        <!-- Gráfico de Investimentos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Gastos por Categoria</h3>
                <div class="chart-container">
                    <canvas id="graficoInvestimentosCategoria"></canvas>
                </div>
            </div>
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Evolução Mensal</h3>
                <div class="chart-container">
                    <canvas id="graficoInvestimentosMensal"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Produção -->
    <div id="producao" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-seedling text-green-600 mr-2 md:mr-3"></i>Controle de Produção - Safras
        </h2>

        <!-- Formulário de Nova Safra -->
        <div class="bg-green-50 p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <h3 class="text-base md:text-lg font-semibold text-green-800 mb-4">Nova Safra</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data de Plantio</label>
                    <input type="date" id="dataPlantio" class="w-full p-2 border rounded-lg editable">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data de Colheita</label>
                    <input type="date" id="dataColheita" class="w-full p-2 border rounded-lg editable">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Área Plantada (ha)</label>
                    <input type="number" id="areaPlantada" class="w-full p-2 border rounded-lg editable"
                        placeholder="0">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Mandioca Colhida (kg)</label>
                    <input type="number" id="mandiocaColhida" class="w-full p-2 border rounded-lg editable"
                        placeholder="0" onchange="calcularProducao()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Farinha Produzida (kg)</label>
                    <input type="number" id="farinhaProduzida" class="w-full p-2 border rounded-lg editable"
                        placeholder="0" onchange="calcularProducao()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Custo Total da Safra (R$)</label>
                    <input type="number" id="custoSafra" class="w-full p-2 border rounded-lg editable"
                        placeholder="0,00" onchange="calcularProducao()">
                </div>
                <div class="flex items-end">
                    <button onclick="adicionarProducao()"
                        class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar Safra
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 bg-white p-4 rounded border">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Eficiência de Conversão</label>
                    <input type="text" id="eficienciaConversao" class="w-full p-2 border rounded-lg bg-gray-100"
                        readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Custo por kg</label>
                    <input type="text" id="custoPorKg" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Custo por Hectare</label>
                    <input type="text" id="custoPorHa" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
            </div>
        </div>

        <!-- Lista de Produções -->
        <div class="overflow-x-auto mb-6">
            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Plantio</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Colheita</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Área (ha)</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Mandioca (kg)</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Farinha (kg)</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Eficiência</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Custo Total</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Custo/kg</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaProducao"></tbody>
            </table>
        </div>

        <!-- Gráfico de Produtividade -->
        <div>
            <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Evolução da Produtividade</h3>
            <div class="chart-container">
                <canvas id="graficoProducao"></canvas>
            </div>
        </div>
    </div>

    <!-- 4. Estoque -->
    <div id="estoque" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-boxes text-green-600 mr-2 md:mr-3"></i>Controle de Estoque
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <!-- Insumos -->
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4 bg-blue-100 p-3 rounded">
                    <i class="fas fa-seedling mr-2"></i>Insumos Agrícolas
                </h3>

                <!-- Adicionar Insumo -->
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="nomeInsumo" class="p-2 border rounded editable"
                            placeholder="Nome do insumo">
                        <input type="number" id="quantidadeInsumo" class="p-2 border rounded editable"
                            placeholder="Quantidade">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" id="validadeInsumo" class="p-2 border rounded editable">
                        <input type="number" id="minimoInsumo" class="p-2 border rounded editable"
                            placeholder="Estoque mínimo">
                    </div>
                    <button onclick="adicionarInsumo()"
                        class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar Insumo
                    </button>
                </div>

                <!-- Lista de Insumos -->
                <div class="space-y-2" id="listaInsumos"></div>
            </div>

            <!-- Farinha Armazenada -->
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4 bg-yellow-100 p-3 rounded">
                    <i class="fas fa-warehouse mr-2"></i>Farinha Armazenada
                </h3>

                <!-- Adicionar Lote de Farinha -->
                <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="loteId" class="p-2 border rounded editable" placeholder="ID do Lote">
                        <input type="number" id="quantidadeFarinha" class="p-2 border rounded editable"
                            placeholder="Quantidade (kg)">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="date" id="dataProducaoFarinha" class="p-2 border rounded editable">
                        <input type="date" id="validadeFarinha" class="p-2 border rounded editable">
                    </div>
                    <input type="number" id="custoArmazenamento" class="w-full p-2 border rounded editable mb-2"
                        placeholder="Custo de Armazenamento (R$)">
                    <button onclick="adicionarFarinha()"
                        class="w-full bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700 transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar Lote
                    </button>
                </div>

                <!-- Lista de Farinha -->
                <div class="space-y-2" id="listaFarinha"></div>
            </div>
        </div>

        <!-- Alertas de Estoque -->
        <div class="mt-8">
            <h3 class="text-base md:text-lg font-semibold text-red-700 mb-4 bg-red-100 p-3 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>Alertas de Estoque
            </h3>
            <div id="alertasEstoque" class="space-y-2"></div>
        </div>
    </div>

    <!-- 5. Gestão de Pessoas -->
    <div id="pessoas" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-users text-green-600 mr-2 md:mr-3"></i>Gestão de Pessoas
        </h2>

        <!-- Adicionar Funcionário -->
        <div class="bg-purple-50 p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <h3 class="text-base md:text-lg font-semibold text-purple-800 mb-4">Adicionar Funcionário</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                    <input type="text" id="nomeFuncionario" class="w-full p-2 border rounded-lg editable"
                        placeholder="Nome completo">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tipo</label>
                    <select id="tipoFuncionario" class="w-full p-2 border rounded-lg editable">
                        <option value="fixo">Fixo</option>
                        <option value="temporario">Temporário</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Salário Mensal (R$)</label>
                    <input type="number" id="salarioFuncionario" class="w-full p-2 border rounded-lg editable"
                        placeholder="0,00">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Função</label>
                    <input type="text" id="funcaoFuncionario" class="w-full p-2 border rounded-lg editable"
                        placeholder="Ex: Operador de máquinas">
                </div>
                <div class="flex items-end">
                    <button onclick="adicionarFuncionario()"
                        class="w-full bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-user-plus mr-2"></i>Adicionar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Funcionários -->
        <div class="overflow-x-auto mb-6">
            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Nome</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Tipo</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Função</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Salário</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Horas/Mês</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaFuncionarios"></tbody>
            </table>
        </div>

        <!-- Registro de Horas -->
        <div class="bg-gray-50 p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">Registro de Horas Trabalhadas</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Funcionário</label>
                    <select id="funcionarioHoras" class="w-full p-2 border rounded-lg editable">
                        <option value="">Selecionar...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data</label>
                    <input type="date" id="dataHoras" class="w-full p-2 border rounded-lg editable">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Horas</label>
                    <input type="number" id="horasTrabalhadas" class="w-full p-2 border rounded-lg editable"
                        placeholder="8" step="0.5">
                </div>
                <div class="flex items-end">
                    <button onclick="registrarHoras()"
                        class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-clock mr-2"></i>Registrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Resumo de RH -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-blue-100 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800">Total de Funcionários</h4>
                <div class="text-2xl font-bold text-blue-600" id="totalFuncionarios">0</div>
            </div>
            <div class="bg-green-100 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800">Custo Mensal com Folha</h4>
                <div class="text-2xl font-bold text-green-600" id="custoFolha">R$ 0</div>
            </div>
            <div class="bg-purple-100 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-800">Horas Trabalhadas (Mês)</h4>
                <div class="text-2xl font-bold text-purple-600" id="horasMes">0h</div>
            </div>
        </div>
    </div>

    <!-- 6. Vendas -->
    <div id="vendas" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-shopping-cart text-green-600 mr-2 md:mr-3"></i>Controle de Vendas
        </h2>

        <!-- Formulário de Nova Venda -->
        <div class="bg-green-50 p-4 md:p-6 rounded-lg mb-4 md:mb-6">
            <h3 class="text-base md:text-lg font-semibold text-green-800 mb-4">Nova Venda</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Data da Venda</label>
                    <input type="date" id="dataVenda" class="w-full p-2 border rounded-lg editable">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Cliente</label>
                    <input type="text" id="clienteVenda" class="w-full p-2 border rounded-lg editable"
                        placeholder="Nome do cliente">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Produto</label>
                    <select id="produtoVenda" class="w-full p-2 border rounded-lg editable" onchange="calcularVenda()">
                        <option value="mandioca">Mandioca in natura</option>
                        <option value="farinha">Farinha de mandioca</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Quantidade (kg)</label>
                    <input type="number" id="quantidadeVenda" class="w-full p-2 border rounded-lg editable"
                        placeholder="0" onchange="calcularVenda()">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Preço Unitário (R$/kg)</label>
                    <input type="number" id="precoUnitario" class="w-full p-2 border rounded-lg editable"
                        placeholder="0,00" step="0.01" onchange="calcularVenda()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Valor Total</label>
                    <input type="text" id="valorTotalVenda" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Taxa Processamento</label>
                    <input type="text" id="taxaProcessamento" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
                <div class="flex items-end">
                    <button onclick="adicionarVenda()"
                        class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-plus mr-2"></i>Registrar Venda
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Vendas -->
        <div class="overflow-x-auto mb-6">
            <table class="w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Data</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Cliente</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Produto</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Quantidade</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Preço Unit.</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Total</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Taxa</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Líquido</th>
                        <th class="border border-gray-300 p-2 md:p-3 text-left">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaVendas"></tbody>
            </table>
        </div>

        <!-- Resumo de Vendas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-green-100 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800">Faturamento Total</h4>
                <div class="text-xl md:text-2xl font-bold text-green-600" id="faturamentoTotal">R$ 0</div>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800">Total de Vendas</h4>
                <div class="text-xl md:text-2xl font-bold text-blue-600" id="totalVendas">0</div>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg">
                <h4 class="font-semibold text-yellow-800">Ticket Médio</h4>
                <div class="text-xl md:text-2xl font-bold text-yellow-600" id="ticketMedio">R$ 0</div>
            </div>
            <div class="bg-purple-100 p-4 rounded-lg">
                <h4 class="font-semibold text-purple-800">Melhor Cliente</h4>
                <div class="text-lg font-bold text-purple-600" id="melhorCliente">-</div>
            </div>
        </div>

        <!-- Gráfico de Vendas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Vendas por Produto</h3>
                <div class="chart-container">
                    <canvas id="graficoVendasProduto"></canvas>
                </div>
            </div>
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Evolução das Vendas</h3>
                <div class="chart-container">
                    <canvas id="graficoVendasEvolucao"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Dashboard Financeiro -->
    <div id="dashboard" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-chart-line text-green-600 mr-2 md:mr-3"></i>Dashboard Financeiro
        </h2>

        <!-- KPIs Principais -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base md:text-lg font-semibold">Faturamento</h3>
                        <div class="text-xl md:text-2xl font-bold" id="dashFaturamento">R$ 0</div>
                    </div>
                    <i class="fas fa-money-bill-wave text-2xl md:text-3xl opacity-75"></i>
                </div>
                <div class="mt-2 text-sm opacity-90">Meta: R$ 1.000.000</div>
            </div>

            <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base md:text-lg font-semibold">Lucro Líquido</h3>
                        <div class="text-xl md:text-2xl font-bold" id="dashLucro">R$ 0</div>
                    </div>
                    <i class="fas fa-chart-line text-2xl md:text-3xl opacity-75"></i>
                </div>
                <div class="mt-2 text-sm opacity-90">Receitas - Despesas</div>
            </div>

            <div class="bg-gradient-to-r from-purple-400 to-purple-600 text-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base md:text-lg font-semibold">ROI</h3>
                        <div class="text-xl md:text-2xl font-bold" id="dashROI">0%</div>
                    </div>
                    <i class="fas fa-percentage text-2xl md:text-3xl opacity-75"></i>
                </div>
                <div class="mt-2 text-sm opacity-90">Retorno do Investimento</div>
            </div>

            <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base md:text-lg font-semibold">Margem</h3>
                        <div class="text-xl md:text-2xl font-bold" id="dashMargem">0%</div>
                    </div>
                    <i class="fas fa-calculator text-2xl md:text-3xl opacity-75"></i>
                </div>
                <div class="mt-2 text-sm opacity-90">Margem de Lucro</div>
            </div>

            <div class="bg-gradient-to-r from-red-400 to-red-600 text-white p-4 md:p-6 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base md:text-lg font-semibold">P. Equilíbrio</h3>
                        <div class="text-xl md:text-2xl font-bold" id="dashPontoEquilibrio">R$ 0</div>
                    </div>
                    <i class="fas fa-balance-scale text-2xl md:text-3xl opacity-75"></i>
                </div>
                <div class="mt-2 text-sm opacity-90">Ponto de Equilíbrio</div>
            </div>
        </div>

        <!-- Progresso da Meta -->
        <div class="bg-green-50 p-4 md:p-6 rounded-lg mb-8">
            <h3 class="text-base md:text-lg font-semibold text-green-800 mb-4">Progresso para Meta de R$ 1.000.000
            </h3>
            <div class="w-full bg-green-200 rounded-full h-6">
                <div class="bg-green-600 h-6 rounded-full transition-all duration-500" id="progressBarDash"
                    style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-green-700">
                <span>R$ 0</span>
                <span id="progressoTexto">0% da Meta</span>
                <span>R$ 1.000.000</span>
            </div>
        </div>

        <!-- Gráficos Financeiros -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Evolução Financeira</h3>
                <div class="chart-container">
                    <canvas id="graficoEvolucaoFinanceira"></canvas>
                </div>
            </div>
            <div>
                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Distribuição de Custos</h3>
                <div class="chart-container">
                    <canvas id="graficoDistribuicaoCustos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 8. Projeções -->
    <div id="projecoes" class="tab-content bg-white rounded-lg shadow-sm p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 flex items-center">
            <i class="fas fa-crystal-ball text-green-600 mr-2 md:mr-3"></i>Projeções e Cenários
        </h2>

        <!-- Simulador de Cenários -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-yellow-50 p-4 md:p-6 rounded-lg">
                <h3 class="text-base md:text-lg font-semibold text-yellow-800 mb-4">Cenário Conservador</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Produtividade (kg/ha)</label>
                        <input type="number" id="prodConservador" class="w-full p-2 border rounded-lg editable"
                            value="15000" onchange="calcularCenarios()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Preço Farinha (R$/kg)</label>
                        <input type="number" id="precoConservador" class="w-full p-2 border rounded-lg editable"
                            value="3.50" step="0.01" onchange="calcularCenarios()">
                    </div>
                    <div class="bg-yellow-100 p-3 rounded">
                        <div class="text-sm font-medium text-yellow-800">Receita Anual Projetada</div>
                        <div class="text-lg font-bold text-yellow-600" id="receitaConservador">R$ 0</div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 md:p-6 rounded-lg">
                <h3 class="text-base md:text-lg font-semibold text-blue-800 mb-4">Cenário Realista</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Produtividade (kg/ha)</label>
                        <input type="number" id="prodRealista" class="w-full p-2 border rounded-lg editable"
                            value="20000" onchange="calcularCenarios()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Preço Farinha (R$/kg)</label>
                        <input type="number" id="precoRealista" class="w-full p-2 border rounded-lg editable"
                            value="4.00" step="0.01" onchange="calcularCenarios()">
                    </div>
                    <div class="bg-blue-100 p-3 rounded">
                        <div class="text-sm font-medium text-blue-800">Receita Anual Projetada</div>
                        <div class="text-lg font-bold text-blue-600" id="receitaRealista">R$ 0</div>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 p-4 md:p-6 rounded-lg">
                <h3 class="text-base md:text-lg font-semibold text-green-800 mb-4">Cenário Otimista</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Produtividade (kg/ha)</label>
                        <input type="number" id="prodOtimista" class="w-full p-2 border rounded-lg editable"
                            value="25000" onchange="calcularCenarios()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Preço Farinha (R$/kg)</label>
                        <input type="number" id="precoOtimista" class="w-full p-2 border rounded-lg editable"
                            value="4.50" step="0.01" onchange="calcularCenarios()">
                    </div>
                    <div class="bg-green-100 p-3 rounded">
                        <div class="text-sm font-medium text-green-800">Receita Anual Projetada</div>
                        <div class="text-lg font-bold text-green-600" id="receitaOtimista">R$ 0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simulador de Expansão -->
        <div class="bg-purple-50 p-4 md:p-6 rounded-lg mb-8">
            <h3 class="text-base md:text-lg font-semibold text-purple-800 mb-4">Simulador de Expansão</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Meta de Faturamento (R$)</label>
                    <input type="number" id="metaFaturamento" class="w-full p-2 border rounded-lg editable"
                        value="1000000" onchange="calcularExpansao()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Área Necessária (ha)</label>
                    <input type="text" id="areaNecessaria" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Investimento Adicional</label>
                    <input type="text" id="investimentoAdicional" class="w-full p-2 border rounded-lg bg-gray-100"
                        readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tempo para Meta</label>
                    <input type="text" id="tempoMeta" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                </div>
            </div>
        </div>

        <!-- Gráfico de Projeções -->
        <div>
            <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-4">Comparativo de Cenários</h3>
            <div class="chart-container">
                <canvas id="graficoProjecoes"></canvas>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Variáveis globais
        let currentUser = null;
        let dadosInvestimentos = [];
        let dadosProducao = [];
        let dadosEstoque = { insumos: [], farinha: [] };
        let dadosFuncionarios = [];
        let dadosHoras = [];
        let dadosVendas = [];
        let propriedade = {};
        let saveTimeout = null;

        // Aguardar carregamento dos módulos Firebase
        setTimeout(() => {
            initializeSystem();
        }, 1000);

        // Função utilitária para prevenir múltiplos cliques
        function debounceButton(button, func, delay = 1000) {
            let timeout;
            return function (...args) {
                if (button.disabled) return;

                button.disabled = true;
                button.style.opacity = '0.7';

                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                }, delay);

                return func.apply(this, args);
            };
        }

        // Função para validar e formatar campos monetários
        function validarCampoMonetario(input) {
            const valor = parseFloat(input.value);
            if (isNaN(valor) || valor < 0) {
                input.value = 0;
                input.style.borderColor = '#EF4444'; // Vermelho para erro
                setTimeout(() => {
                    input.style.borderColor = '';
                }, 2000);
                return 0;
            }
            input.style.borderColor = '#10B981'; // Verde para sucesso
            setTimeout(() => {
                input.style.borderColor = '';
            }, 1000);
            return valor;
        }

        // Aplicar validação em todos os campos monetários
        function aplicarValidacaoMonetaria() {
            const camposMonetarios = [
                'valorTerra', 'limpezaTerreno', 'insumosAgricolas',
                'ferramentasMaquinario', 'infraestrutura', 'maoObraInicial',
                'valorInvestimento', 'custoSafra', 'custoArmazenamento',
                'salarioFuncionario', 'precoUnitario', 'precoConservador',
                'precoRealista', 'precoOtimista', 'metaFaturamento'
            ];

            camposMonetarios.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener('blur', () => validarCampoMonetario(campo));
                    campo.step = '0.01';
                    campo.min = '0';
                }
            });
        }


        function initializeSystem() {
            // Verificar autenticação
            window.firebaseAuth.onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    currentUser = user.email;
                    document.getElementById('currentUser').textContent = currentUser;
                    showMainSystem();
                    carregarDados();
                    aplicarValidacaoMonetaria();
                } else {
                    showLoginScreen();
                }
            });

            // Event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Auto-save original (backup)
            setInterval(salvarDados, 30000); // Auto-save backup a cada 30 segundos

            // Auto-save imediato para campos editáveis
            setupAutoSaveListeners();
        }

        // ============= NOVA FUNCIONALIDADE: AUTO-SAVE IMEDIATO =============
        function setupAutoSaveListeners() {
            // Aguardar o DOM estar completamente carregado
            setTimeout(() => {
                const editableFields = document.querySelectorAll('.editable');
                editableFields.forEach(field => {
                    // Eventos para input
                    field.addEventListener('input', debouncedSave);
                    field.addEventListener('change', debouncedSave);
                    field.addEventListener('blur', debouncedSave);
                });
            }, 2000);
        }

        function debouncedSave() {
            // Limpar timeout anterior se existir
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            // Definir novo timeout para salvar após 1 segundo de inatividade
            saveTimeout = setTimeout(() => {
                salvarPropriedade(); // Atualizar propriedade se necessário
                salvarDados(); // Salvar todos os dados
                showSaveIndicator(); // Mostrar indicador
            }, 1000);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Autenticação Firebase
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggleIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        async function loginUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showAuthMessage('Por favor, preencha todos os campos!', 'error');
                return;
            }

            try {
                loginBtn.innerHTML = '<div class="loading mr-2"></div>Entrando...';
                loginBtn.disabled = true;

                await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
                showAuthMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no login:', error);
                let errorMessage = 'Erro no login. Tente novamente.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuário não encontrado.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Senha incorreta.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido.';
                }

                showAuthMessage(errorMessage, 'error');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                loginBtn.disabled = false;
            }
        }

        async function registerUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const registerBtn = document.getElementById('registerBtn');

            if (!email || !password) {
                showAuthMessage('Por favor, preencha todos os campos!', 'error');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }

            try {
                registerBtn.innerHTML = '<div class="loading mr-2"></div>Cadastrando...';
                registerBtn.disabled = true;

                await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, email, password);
                showAuthMessage('Conta criada com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no cadastro:', error);
                let errorMessage = 'Erro no cadastro. Tente novamente.';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email já está em uso.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido.';
                }

                showAuthMessage(errorMessage, 'error');
            } finally {
                registerBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Cadastrar';
                registerBtn.disabled = false;
            }
        }

        async function logoutUser() {
            try {
                await salvarDados();
                await window.firebaseAuth.signOut(window.auth);
                showAuthMessage('Logout realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        }

        function showAuthMessage(message, type) {
            const authMessage = document.getElementById('authMessage');
            authMessage.className = `mt-4 p-4 rounded-lg text-center ${type === 'error' ? 'bg-red-100 border border-red-300 text-red-700' : 'bg-green-100 border border-green-300 text-green-700'}`;
            authMessage.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>${message}`;
            authMessage.classList.remove('hidden');

            setTimeout(() => {
                authMessage.classList.add('hidden');
            }, 5000);
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').classList.remove('authenticated');
        }

        function showMainSystem() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainSystem').classList.add('authenticated');
        }

        // Persistência de dados com Firestore
        async function salvarDados() {
            if (!currentUser) return;

            try {
                const dados = {
                    usuario: currentUser,
                    timestamp: new Date().toISOString(),
                    propriedade: propriedade,
                    investimentos: dadosInvestimentos,
                    producao: dadosProducao,
                    estoque: dadosEstoque,
                    funcionarios: dadosFuncionarios,
                    horas: dadosHoras,
                    vendas: dadosVendas
                };

                const userDocRef = window.firestore.doc(window.db, 'fazendas', currentUser);
                await window.firestore.setDoc(userDocRef, dados);

                console.log('Dados salvos com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                // Mostrar erro na interface
                const indicator = document.getElementById('saveIndicator');
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Erro ao salvar';
                indicator.style.backgroundColor = '#EF4444';
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.innerHTML = '<i class="fas fa-check mr-2"></i>Dados salvos automaticamente';
                    indicator.style.backgroundColor = '#10B981';
                }, 3000);
            }
        }


        async function carregarDados() {
            if (!currentUser) return;

            try {
                const userDocRef = window.firestore.doc(window.db, 'fazendas', currentUser);
                const docSnap = await window.firestore.getDoc(userDocRef);

                if (docSnap.exists()) {
                    const dados = docSnap.data();

                    propriedade = dados.propriedade || {};
                    dadosInvestimentos = dados.investimentos || [];
                    dadosProducao = dados.producao || [];
                    dadosEstoque = dados.estoque || { insumos: [], farinha: [] };
                    dadosFuncionarios = dados.funcionarios || [];
                    dadosHoras = dados.horas || [];
                    dadosVendas = dados.vendas || [];

                    console.log('Dados carregados:', {
                        propriedade,
                        investimentos: dadosInvestimentos.length,
                        producao: dadosProducao.length,
                        funcionarios: dadosFuncionarios.length,
                        vendas: dadosVendas.length
                    });

                    // Carregar dados na interface
                    carregarPropriedade();
                    atualizarTabelaInvestimentos();
                    atualizarTabelaProducao();
                    atualizarListaInsumos();
                    atualizarListaFarinha();
                    atualizarTabelaFuncionarios();
                    atualizarTabelaVendas();

                    // Aguardar um momento para o DOM estar pronto e então atualizar o dashboard
                    setTimeout(() => {
                        console.log('Iniciando atualização do dashboard após carregamento...');
                        atualizarDashboard();

                        // Aguardar um pouco mais para gráficos
                        setTimeout(() => {
                            try {
                                if (typeof calcularCenarios === 'function') calcularCenarios();
                                if (typeof calcularExpansao === 'function') calcularExpansao();
                            } catch (error) {
                                console.warn('Erro ao calcular cenários/expansão:', error);
                            }
                        }, 200);
                    }, 300);

                    // Configurar listeners para campos carregados
                    setupAutoSaveListeners();

                    console.log('Dados carregados com sucesso!');
                } else {
                    console.log('Nenhum dado encontrado, iniciando com dados vazios.');
                    atualizarDashboard(); // Garantir que o dashboard seja atualizado mesmo sem dados
                    setupAutoSaveListeners();
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }


        // Navegação entre abas
        function switchTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-green-600', 'border-green-600');
                btn.classList.add('text-gray-600', 'border-transparent');
            });

            // Ativar aba selecionada
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'text-green-600', 'border-green-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-600', 'border-transparent');

            // Se está indo para o dashboard, forçar atualização
            if (tabName === 'dashboard') {
                setTimeout(() => atualizarDashboard(), 100);
            }
        }

        // Funções de cálculo da propriedade
        function calcularArea() {
            const hectares = parseFloat(document.getElementById('areaHa').value) || 0;
            const metros = hectares * 10000;
            document.getElementById('areaM2').value = metros;
            salvarPropriedade();
        }

        function calcularInvestimentoTotal() {
            const valorTerra = parseFloat(document.getElementById('valorTerra').value) || 0;
            const limpeza = parseFloat(document.getElementById('limpezaTerreno').value) || 0;
            const insumos = parseFloat(document.getElementById('insumosAgricolas').value) || 0;
            const ferramentas = parseFloat(document.getElementById('ferramentasMaquinario').value) || 0;
            const infraestrutura = parseFloat(document.getElementById('infraestrutura').value) || 0;
            const maoObra = parseFloat(document.getElementById('maoObraInicial').value) || 0;

            const total = valorTerra + limpeza + insumos + ferramentas + infraestrutura + maoObra;
            document.getElementById('totalInvestimento').textContent = formatarMoeda(total);
            salvarPropriedade();
        }

        function salvarPropriedade() {
            const nomeEl = document.getElementById('nomePropriedade');
            const areaHaEl = document.getElementById('areaHa');
            const areaM2El = document.getElementById('areaM2');
            const localizacaoEl = document.getElementById('localizacao');
            const valorTerraEl = document.getElementById('valorTerra');
            const limpezaTerrenoEl = document.getElementById('limpezaTerreno');
            const insumosAgricolasEl = document.getElementById('insumosAgricolas');
            const ferramentasMaquinarioEl = document.getElementById('ferramentasMaquinario');
            const infraestruturaEl = document.getElementById('infraestrutura');
            const maoObraInicialEl = document.getElementById('maoObraInicial');

            propriedade = {
                nome: nomeEl ? nomeEl.value : '',
                areaHa: areaHaEl ? parseFloat(areaHaEl.value) || 0 : 0,
                areaM2: areaM2El ? parseFloat(areaM2El.value) || 0 : 0,
                localizacao: localizacaoEl ? localizacaoEl.value : '',
                valorTerra: valorTerraEl ? parseFloat(valorTerraEl.value) || 0 : 0,
                limpezaTerreno: limpezaTerrenoEl ? parseFloat(limpezaTerrenoEl.value) || 0 : 0,
                insumosAgricolas: insumosAgricolasEl ? parseFloat(insumosAgricolasEl.value) || 0 : 0,
                ferramentasMaquinario: ferramentasMaquinarioEl ? parseFloat(ferramentasMaquinarioEl.value) || 0 : 0,
                infraestrutura: infraestruturaEl ? parseFloat(infraestruturaEl.value) || 0 : 0,
                maoObraInicial: maoObraInicialEl ? parseFloat(maoObraInicialEl.value) || 0 : 0
            };
        }

        function carregarPropriedade() {
            if (propriedade.nome) document.getElementById('nomePropriedade').value = propriedade.nome;
            if (propriedade.areaHa) document.getElementById('areaHa').value = propriedade.areaHa;
            if (propriedade.areaM2) document.getElementById('areaM2').value = propriedade.areaM2;
            if (propriedade.localizacao) document.getElementById('localizacao').value = propriedade.localizacao;
            if (propriedade.valorTerra) document.getElementById('valorTerra').value = propriedade.valorTerra;
            if (propriedade.limpezaTerreno) document.getElementById('limpezaTerreno').value = propriedade.limpezaTerreno;
            if (propriedade.insumosAgricolas) document.getElementById('insumosAgricolas').value = propriedade.insumosAgricolas;
            if (propriedade.ferramentasMaquinario) document.getElementById('ferramentasMaquinario').value = propriedade.ferramentasMaquinario;
            if (propriedade.infraestrutura) document.getElementById('infraestrutura').value = propriedade.infraestrutura;
            if (propriedade.maoObraInicial) document.getElementById('maoObraInicial').value = propriedade.maoObraInicial;
            calcularInvestimentoTotal();
        }

        // Funções de investimentos
        function adicionarInvestimento() {
            const data = document.getElementById('dataInvestimento').value;
            const descricao = document.getElementById('descricaoInvestimento').value;
            const categoria = document.getElementById('categoriaInvestimento').value;
            const valor = parseFloat(document.getElementById('valorInvestimento').value);
            const tipo = document.getElementById('tipoInvestimento').value;
            const safra = document.getElementById('safraInvestimento').value;

            if (!data || !descricao || !valor) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            const investimento = {
                id: Date.now(),
                data,
                descricao,
                categoria,
                valor,
                tipo,
                safra
            };

            dadosInvestimentos.push(investimento);
            atualizarTabelaInvestimentos();
            atualizarGraficosInvestimentos();
            atualizarDashboard();
            forcarAtualizacaoCompleta();

            // Limpar formulário
            document.getElementById('dataInvestimento').value = '';
            document.getElementById('descricaoInvestimento').value = '';
            document.getElementById('valorInvestimento').value = '';
            document.getElementById('safraInvestimento').value = '';

            salvarDados();
        }

        function atualizarTabelaInvestimentos() {
            const tabela = document.getElementById('tabelaInvestimentos');
            tabela.innerHTML = '';

            dadosInvestimentos.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2 md:p-3">${formatarData(item.data)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.descricao}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.categoria}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.valor)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.tipo}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.safra}</td>
                    <td class="border border-gray-300 p-2 md:p-3">
                        <button onclick="removerInvestimento(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabela.appendChild(row);
            });
        }

        function removerInvestimento(id) {
            if (confirm('Tem certeza que deseja remover este investimento?')) {
                dadosInvestimentos = dadosInvestimentos.filter(item => item.id !== id);
                atualizarTabelaInvestimentos();
                atualizarGraficosInvestimentos();
                atualizarDashboard();
                salvarDados();
            }
        }

        function atualizarGraficosInvestimentos() {
            // Gráfico por categoria
            const categorias = {};
            dadosInvestimentos.forEach(item => {
                categorias[item.categoria] = (categorias[item.categoria] || 0) + item.valor;
            });

            const ctxCategoria = document.getElementById('graficoInvestimentosCategoria');
            if (window.graficoCategoria) window.graficoCategoria.destroy();

            window.graficoCategoria = new Chart(ctxCategoria, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#10B981', '#3B82F6', '#EF4444', '#F59E0B', '#8B5CF6', '#06B6D4', '#84CC16']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Gráfico mensal
            const meses = {};
            dadosInvestimentos.forEach(item => {
                const mes = item.data.substring(0, 7);
                meses[mes] = (meses[mes] || 0) + item.valor;
            });

            const ctxMensal = document.getElementById('graficoInvestimentosMensal');
            if (window.graficoMensal) window.graficoMensal.destroy();

            window.graficoMensal = new Chart(ctxMensal, {
                type: 'line',
                data: {
                    labels: Object.keys(meses).sort(),
                    datasets: [{
                        label: 'Investimentos Mensais',
                        data: Object.keys(meses).sort().map(mes => meses[mes]),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funções de produção
        function calcularProducao() {
            const mandioca = parseFloat(document.getElementById('mandiocaColhida').value) || 0;
            const farinha = parseFloat(document.getElementById('farinhaProduzida').value) || 0;
            const custo = parseFloat(document.getElementById('custoSafra').value) || 0;
            const area = parseFloat(document.getElementById('areaPlantada').value) || 0;

            // Eficiência de conversão
            const eficiencia = mandioca > 0 ? ((farinha / mandioca) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('eficienciaConversao').value = eficiencia;

            // Custo por kg
            const custoPorKg = farinha > 0 ? (custo / farinha).toFixed(2) : '0.00';
            document.getElementById('custoPorKg').value = 'R$ ' + custoPorKg;

            // Custo por hectare
            const custoPorHa = area > 0 ? (custo / area).toFixed(2) : '0.00';
            document.getElementById('custoPorHa').value = 'R$ ' + custoPorHa;
        }

        function adicionarProducao() {
            const dataPlantio = document.getElementById('dataPlantio').value;
            const dataColheita = document.getElementById('dataColheita').value;
            const areaPlantada = parseFloat(document.getElementById('areaPlantada').value);
            const mandiocaColhida = parseFloat(document.getElementById('mandiocaColhida').value);
            const farinhaProduzida = parseFloat(document.getElementById('farinhaProduzida').value);
            const custoSafra = parseFloat(document.getElementById('custoSafra').value);

            if (!dataPlantio || !dataColheita || !areaPlantada || !mandiocaColhida || !farinhaProduzida || !custoSafra) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const eficiencia = ((farinhaProduzida / mandiocaColhida) * 100).toFixed(1);
            const custoPorKg = (custoSafra / farinhaProduzida).toFixed(2);
            const custoPorHa = (custoSafra / areaPlantada).toFixed(2);

            const producao = {
                id: Date.now(),
                dataPlantio,
                dataColheita,
                areaPlantada,
                mandiocaColhida,
                farinhaProduzida,
                custoSafra,
                eficiencia,
                custoPorKg,
                custoPorHa
            };

            dadosProducao.push(producao);
            atualizarTabelaProducao();
            atualizarGraficoProducao();
            atualizarDashboard();
            forcarAtualizacaoCompleta();

            // Limpar formulário
            document.getElementById('dataPlantio').value = '';
            document.getElementById('dataColheita').value = '';
            document.getElementById('areaPlantada').value = '';
            document.getElementById('mandiocaColhida').value = '';
            document.getElementById('farinhaProduzida').value = '';
            document.getElementById('custoSafra').value = '';
            document.getElementById('eficienciaConversao').value = '';
            document.getElementById('custoPorKg').value = '';
            document.getElementById('custoPorHa').value = '';

            salvarDados();
        }

        function atualizarTabelaProducao() {
            const tabela = document.getElementById('tabelaProducao');
            tabela.innerHTML = '';

            dadosProducao.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2 md:p-3">${formatarData(item.dataPlantio)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarData(item.dataColheita)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.areaPlantada}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.mandiocaColhida.toLocaleString()}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.farinhaProduzida.toLocaleString()}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.eficiencia}%</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.custoSafra)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">R$ ${item.custoPorKg}</td>
                    <td class="border border-gray-300 p-2 md:p-3">
                        <button onclick="removerProducao(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabela.appendChild(row);
            });
        }

        function removerProducao(id) {
            if (confirm('Tem certeza que deseja remover esta produção?')) {
                dadosProducao = dadosProducao.filter(item => item.id !== id);
                atualizarTabelaProducao();
                atualizarGraficoProducao();
                atualizarDashboard();
                salvarDados();
            }
        }

        function atualizarGraficoProducao() {
            const ctx = document.getElementById('graficoProducao');
            if (window.graficoProducaoChart) window.graficoProducaoChart.destroy();

            const labels = dadosProducao.map(item => formatarData(item.dataColheita));
            const produtividade = dadosProducao.map(item => item.farinhaProduzida / item.areaPlantada);

            window.graficoProducaoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Produtividade (kg/ha)',
                        data: produtividade,
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'kg/ha'
                            }
                        }
                    }
                }
            });
        }

        // Funções de estoque
        function adicionarInsumo() {
            const nome = document.getElementById('nomeInsumo').value;
            const quantidade = parseFloat(document.getElementById('quantidadeInsumo').value);
            const validade = document.getElementById('validadeInsumo').value;
            const minimo = parseFloat(document.getElementById('minimoInsumo').value);

            if (!nome || !quantidade || !validade || !minimo) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const insumo = {
                id: Date.now(),
                nome,
                quantidade,
                validade,
                minimo
            };

            dadosEstoque.insumos.push(insumo);
            atualizarListaInsumos();
            atualizarAlertas();

            // Limpar formulário
            document.getElementById('nomeInsumo').value = '';
            document.getElementById('quantidadeInsumo').value = '';
            document.getElementById('validadeInsumo').value = '';
            document.getElementById('minimoInsumo').value = '';

            salvarDados();
        }

        function atualizarListaInsumos() {
            const lista = document.getElementById('listaInsumos');
            lista.innerHTML = '';

            dadosEstoque.insumos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded border flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">${item.nome}</div>
                        <div class="text-sm text-gray-600">
                            Qtd: ${item.quantidade} | Min: ${item.minimo} | Val: ${formatarData(item.validade)}
                        </div>
                    </div>
                    <button onclick="removerInsumo(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                lista.appendChild(div);
            });
        }

        function removerInsumo(id) {
            if (confirm('Tem certeza que deseja remover este insumo?')) {
                dadosEstoque.insumos = dadosEstoque.insumos.filter(item => item.id !== id);
                atualizarListaInsumos();
                atualizarAlertas();
                salvarDados();
            }
        }

        function adicionarFarinha() {
            const loteId = document.getElementById('loteId').value;
            const quantidade = parseFloat(document.getElementById('quantidadeFarinha').value);
            const dataProducao = document.getElementById('dataProducaoFarinha').value;
            const validade = document.getElementById('validadeFarinha').value;
            const custoArmazenamento = parseFloat(document.getElementById('custoArmazenamento').value);

            if (!loteId || !quantidade || !dataProducao || !validade || !custoArmazenamento) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const farinha = {
                id: Date.now(),
                loteId,
                quantidade,
                dataProducao,
                validade,
                custoArmazenamento
            };

            dadosEstoque.farinha.push(farinha);
            atualizarListaFarinha();
            atualizarAlertas();

            // Limpar formulário
            document.getElementById('loteId').value = '';
            document.getElementById('quantidadeFarinha').value = '';
            document.getElementById('dataProducaoFarinha').value = '';
            document.getElementById('validadeFarinha').value = '';
            document.getElementById('custoArmazenamento').value = '';

            salvarDados();
        }

        function atualizarListaFarinha() {
            const lista = document.getElementById('listaFarinha');
            lista.innerHTML = '';

            dadosEstoque.farinha.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded border flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <div class="font-medium">Lote: ${item.loteId}</div>
                        <div class="text-sm text-gray-600">
                            ${item.quantidade}kg | Prod: ${formatarData(item.dataProducao)} | Val: ${formatarData(item.validade)}
                        </div>
                        <div class="text-sm text-gray-600">Custo: ${formatarMoeda(item.custoArmazenamento)}</div>
                    </div>
                    <button onclick="removerFarinha(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                lista.appendChild(div);
            });
        }

        function removerFarinha(id) {
            if (confirm('Tem certeza que deseja remover este lote?')) {
                dadosEstoque.farinha = dadosEstoque.farinha.filter(item => item.id !== id);
                atualizarListaFarinha();
                atualizarAlertas();
                salvarDados();
            }
        }

        function atualizarAlertas() {
            const alertas = document.getElementById('alertasEstoque');
            alertas.innerHTML = '';

            const hoje = new Date();
            const proximoMes = new Date();
            proximoMes.setMonth(proximoMes.getMonth() + 1);

            // Alertas de insumos
            dadosEstoque.insumos.forEach(item => {
                const validade = new Date(item.validade);

                if (item.quantidade <= item.minimo) {
                    const div = document.createElement('div');
                    div.className = 'bg-red-100 border border-red-300 text-red-700 p-3 rounded';
                    div.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Estoque baixo: ${item.nome} (${item.quantidade} unidades)`;
                    alertas.appendChild(div);
                }

                if (validade <= proximoMes) {
                    const div = document.createElement('div');
                    div.className = 'bg-yellow-100 border border-yellow-300 text-yellow-700 p-3 rounded';
                    div.innerHTML = `<i class="fas fa-clock mr-2"></i>Validade próxima: ${item.nome} (${formatarData(item.validade)})`;
                    alertas.appendChild(div);
                }
            });

            // Alertas de farinha
            dadosEstoque.farinha.forEach(item => {
                const validade = new Date(item.validade);

                if (validade <= proximoMes) {
                    const div = document.createElement('div');
                    div.className = 'bg-yellow-100 border border-yellow-300 text-yellow-700 p-3 rounded';
                    div.innerHTML = `<i class="fas fa-clock mr-2"></i>Farinha vencendo: Lote ${item.loteId} (${formatarData(item.validade)})`;
                    alertas.appendChild(div);
                }
            });

            if (alertas.children.length === 0) {
                const div = document.createElement('div');
                div.className = 'bg-green-100 border border-green-300 text-green-700 p-3 rounded';
                div.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Nenhum alerta de estoque no momento.';
                alertas.appendChild(div);
            }
        }

        // Funções de funcionários
        function adicionarFuncionario() {
            const nome = document.getElementById('nomeFuncionario').value;
            const tipo = document.getElementById('tipoFuncionario').value;
            const salario = parseFloat(document.getElementById('salarioFuncionario').value);
            const funcao = document.getElementById('funcaoFuncionario').value;

            if (!nome || !salario || !funcao) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const funcionario = {
                id: Date.now(),
                nome,
                tipo,
                salario,
                funcao,
                horasMes: 0
            };

            dadosFuncionarios.push(funcionario);
            atualizarTabelaFuncionarios();
            atualizarSelectFuncionarios();
            atualizarResumoRH();
            atualizarDashboard();

            // Limpar formulário
            document.getElementById('nomeFuncionario').value = '';
            document.getElementById('salarioFuncionario').value = '';
            document.getElementById('funcaoFuncionario').value = '';

            salvarDados();
        }

        function atualizarTabelaFuncionarios() {
            const tabela = document.getElementById('tabelaFuncionarios');
            tabela.innerHTML = '';

            dadosFuncionarios.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2 md:p-3">${item.nome}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.tipo}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.funcao}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.salario)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.horasMes || 0}h</td>
                    <td class="border border-gray-300 p-2 md:p-3">
                        <button onclick="removerFuncionario(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabela.appendChild(row);
            });
        }

        function removerFuncionario(id) {
            if (confirm('Tem certeza que deseja remover este funcionário?')) {
                // Remover também registros de horas órfãos
                dadosHoras = dadosHoras.filter(h => h.funcionarioId !== id);
                dadosFuncionarios = dadosFuncionarios.filter(item => item.id !== id);
                atualizarTabelaFuncionarios();
                atualizarSelectFuncionarios();
                atualizarResumoRH();
                atualizarDashboard();
                salvarDados();
            }
        }

        function atualizarSelectFuncionarios() {
            const select = document.getElementById('funcionarioHoras');
            select.innerHTML = '<option value="">Selecionar...</option>';

            dadosFuncionarios.forEach(funcionario => {
                const option = document.createElement('option');
                option.value = funcionario.id;
                option.textContent = funcionario.nome;
                select.appendChild(option);
            });
        }

        function registrarHoras() {
            const funcionarioId = parseInt(document.getElementById('funcionarioHoras').value);
            const data = document.getElementById('dataHoras').value;
            const horas = parseFloat(document.getElementById('horasTrabalhadas').value);

            if (!funcionarioId || !data || !horas) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const registro = {
                id: Date.now(),
                funcionarioId,
                data,
                horas
            };

            dadosHoras.push(registro);

            // Atualizar horas mensais do funcionário
            const funcionario = dadosFuncionarios.find(f => f.id === funcionarioId);
            if (funcionario) {
                const mesAtual = new Date().toISOString().substring(0, 7);
                const horasDoMes = dadosHoras
                    .filter(h => h.funcionarioId === funcionarioId && h.data.substring(0, 7) === mesAtual)
                    .reduce((total, h) => total + h.horas, 0);
                funcionario.horasMes = horasDoMes;
            }

            atualizarTabelaFuncionarios();
            atualizarResumoRH();

            // Limpar formulário
            document.getElementById('funcionarioHoras').value = '';
            document.getElementById('dataHoras').value = '';
            document.getElementById('horasTrabalhadas').value = '';

            salvarDados();
        }

        function atualizarResumoRH() {
            const totalFuncionarios = dadosFuncionarios.length;
            const custoFolha = dadosFuncionarios.reduce((total, f) => total + f.salario, 0);
            const horasMes = dadosFuncionarios.reduce((total, f) => total + (f.horasMes || 0), 0);

            document.getElementById('totalFuncionarios').textContent = totalFuncionarios;
            document.getElementById('custoFolha').textContent = formatarMoeda(custoFolha);
            document.getElementById('horasMes').textContent = horasMes + 'h';
        }

        // Funções de vendas
        function calcularVenda() {
            const produto = document.getElementById('produtoVenda').value;
            const quantidade = parseFloat(document.getElementById('quantidadeVenda').value) || 0;
            const precoUnitario = parseFloat(document.getElementById('precoUnitario').value) || 0;

            const valorTotal = quantidade * precoUnitario;
            const taxaProcessamento = valorTotal * 0.03; // 3% de taxa

            document.getElementById('valorTotalVenda').value = formatarMoeda(valorTotal);
            document.getElementById('taxaProcessamento').value = formatarMoeda(taxaProcessamento);
        }

        function adicionarVenda() {
            const data = document.getElementById('dataVenda').value;
            const cliente = document.getElementById('clienteVenda').value;
            const produto = document.getElementById('produtoVenda').value;
            const quantidade = parseFloat(document.getElementById('quantidadeVenda').value);
            const precoUnitario = parseFloat(document.getElementById('precoUnitario').value);

            if (!data || !cliente || !quantidade || !precoUnitario) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            const valorTotal = quantidade * precoUnitario;
            const taxa = valorTotal * 0.03;
            const liquido = valorTotal - taxa;

            const venda = {
                id: Date.now(),
                data,
                cliente,
                produto,
                quantidade,
                precoUnitario,
                valorTotal,
                taxa,
                liquido
            };

            dadosVendas.push(venda);
            atualizarTabelaVendas();
            atualizarResumoVendas();
            atualizarGraficosVendas();
            atualizarDashboard();
            forcarAtualizacaoCompleta();

            // Limpar formulário
            document.getElementById('dataVenda').value = '';
            document.getElementById('clienteVenda').value = '';
            document.getElementById('quantidadeVenda').value = '';
            document.getElementById('precoUnitario').value = '';
            document.getElementById('valorTotalVenda').value = '';
            document.getElementById('taxaProcessamento').value = '';

            salvarDados();
        }

        function atualizarTabelaVendas() {
            const tabela = document.getElementById('tabelaVendas');
            tabela.innerHTML = '';

            dadosVendas.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2 md:p-3">${formatarData(item.data)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.cliente}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.produto}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${item.quantidade}kg</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.precoUnitario)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.valorTotal)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.taxa)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">${formatarMoeda(item.liquido)}</td>
                    <td class="border border-gray-300 p-2 md:p-3">
                        <button onclick="removerVenda(${item.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabela.appendChild(row);
            });
        }

        function removerVenda(id) {
            if (confirm('Tem certeza que deseja remover esta venda?')) {
                dadosVendas = dadosVendas.filter(item => item.id !== id);
                atualizarTabelaVendas();
                atualizarResumoVendas();
                atualizarGraficosVendas();
                atualizarDashboard();
                salvarDados();
            }
        }

        function atualizarResumoVendas() {
            const faturamentoTotal = dadosVendas.reduce((total, v) => total + (v.liquido || 0), 0);
            const totalVendas = dadosVendas.length;
            const ticketMedio = totalVendas > 0 ? faturamentoTotal / totalVendas : 0;

            // Melhor cliente
            const clientes = {};
            dadosVendas.forEach(v => {
                const valorLiquido = v.liquido || 0;
                clientes[v.cliente] = (clientes[v.cliente] || 0) + valorLiquido;
            });
            const melhorCliente = Object.keys(clientes).length > 0 ?
                Object.keys(clientes).reduce((a, b) => clientes[a] > clientes[b] ? a : b) : '-';

            document.getElementById('faturamentoTotal').textContent = formatarMoeda(faturamentoTotal);
            document.getElementById('totalVendas').textContent = totalVendas;
            document.getElementById('ticketMedio').textContent = formatarMoeda(ticketMedio);
            document.getElementById('melhorCliente').textContent = melhorCliente;

            // Atualizar progresso da meta
            atualizarProgressoMeta();
        }

        // ✅ ADICIONAR ou SUBSTITUIR a função atualizarGraficosVendas():
        function atualizarGraficosVendas() {
            // Gráfico de vendas por produto
            const ctxProduto = document.getElementById('graficoVendasProduto');
            if (ctxProduto) {
                if (window.graficoVendasProdutoChart) {
                    window.graficoVendasProdutoChart.destroy();
                    window.graficoVendasProdutoChart = null;
                }

                const produtos = {};
                dadosVendas.forEach(item => {
                    if (item.produto && item.liquido) {
                        const produto = item.produto.charAt(0).toUpperCase() + item.produto.slice(1);
                        produtos[produto] = (produtos[produto] || 0) + item.liquido;
                    }
                });

                if (Object.keys(produtos).length > 0) {
                    window.graficoVendasProdutoChart = new Chart(ctxProduto, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(produtos),
                            datasets: [{
                                data: Object.values(produtos),
                                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Vendas por Produto'
                                }
                            }
                        }
                    });
                }
            }

            // Gráfico de evolução das vendas
            const ctxEvolucao = document.getElementById('graficoVendasEvolucao');
            if (ctxEvolucao) {
                if (window.graficoVendasEvolucaoChart) {
                    window.graficoVendasEvolucaoChart.destroy();
                    window.graficoVendasEvolucaoChart = null;
                }

                const meses = {};
                dadosVendas.forEach(item => {
                    if (item.data && item.liquido) {
                        const mes = item.data.substring(0, 7);
                        meses[mes] = (meses[mes] || 0) + item.liquido;
                    }
                });

                const mesesOrdenados = Object.keys(meses).sort();
                if (mesesOrdenados.length > 0) {
                    window.graficoVendasEvolucaoChart = new Chart(ctxEvolucao, {
                        type: 'line',
                        data: {
                            labels: mesesOrdenados.map(mes => {
                                const [ano, mesNum] = mes.split('-');
                                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                                    'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                                return `${meses[parseInt(mesNum) - 1]}/${ano}`;
                            }),
                            datasets: [{
                                label: 'Vendas Mensais',
                                data: mesesOrdenados.map(mes => meses[mes]),
                                borderColor: '#10B981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Evolução das Vendas'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return formatarMoeda(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }


        // Funções do dashboard (CORRIGIDAS)
        function atualizarDashboard() {
            console.log('Atualizando dashboard com dados:', {
                vendas: dadosVendas.length,
                investimentos: dadosInvestimentos.length,
                producao: dadosProducao.length,
                funcionarios: dadosFuncionarios.length
            });

            // Cálculos financeiros corrigidos
            const faturamento = dadosVendas.reduce((total, v) => total + (v.liquido || 0), 0);
            const investimentos = dadosInvestimentos.reduce((total, i) => total + (i.valor || 0), 0);
            const custoProducao = dadosProducao.reduce((total, p) => total + (p.custoSafra || 0), 0);
            const custoFolhaMensal = dadosFuncionarios.reduce((total, f) => total + (f.salario || 0), 0);
            const custoFolhaAnual = custoFolhaMensal * 12;

            const custoTotal = investimentos + custoProducao + custoFolhaAnual;
            const lucro = faturamento - custoTotal;
            const roi = investimentos > 0 ? ((lucro / investimentos) * 100) : 0;
            const margem = faturamento > 0 ? ((lucro / faturamento) * 100) : 0;
            const pontoEquilibrio = margem > 0 ? (custoTotal / (margem / 100)) : 0;

            // Atualizar elementos do dashboard (verificar se existem)
            const dashFaturamento = document.getElementById('dashFaturamento');
            const dashLucro = document.getElementById('dashLucro');
            const dashROI = document.getElementById('dashROI');
            const dashMargem = document.getElementById('dashMargem');
            const dashPontoEquilibrio = document.getElementById('dashPontoEquilibrio');

            if (dashFaturamento) dashFaturamento.textContent = formatarMoeda(faturamento);
            if (dashLucro) dashLucro.textContent = formatarMoeda(lucro);
            if (dashROI) dashROI.textContent = roi.toFixed(1) + '%';
            if (dashMargem) dashMargem.textContent = margem.toFixed(1) + '%';
            if (dashPontoEquilibrio) dashPontoEquilibrio.textContent = formatarMoeda(pontoEquilibrio);

            // Atualizar progresso da meta SEMPRE
            atualizarProgressoMeta();

            // Atualizar gráficos com verificação de existência
            setTimeout(() => {
                try {
                    atualizarGraficoEvolucaoFinanceira();
                } catch (error) {
                    console.warn('Erro ao atualizar gráfico evolução financeira:', error);
                }

                try {
                    atualizarGraficoDistribuicaoCustos();
                } catch (error) {
                    console.warn('Erro ao atualizar gráfico distribuição custos:', error);
                }

                try {
                    atualizarGraficosInvestimentos();
                } catch (error) {
                    console.warn('Erro ao atualizar gráficos investimentos:', error);
                }

                try {
                    atualizarGraficoProducao();
                } catch (error) {
                    console.warn('Erro ao atualizar gráfico produção:', error);
                }

                try {
                    atualizarGraficosVendas();
                } catch (error) {
                    console.warn('Erro ao atualizar gráficos vendas:', error);
                }
            }, 100);
        }

        // ✅ SUBSTITUIR a função atualizarGraficoEvolucaoFinanceira() existente:
        function atualizarGraficoEvolucaoFinanceira() {
            const ctx = document.getElementById('graficoEvolucaoFinanceira');
            if (!ctx) {
                console.warn('Elemento graficoEvolucaoFinanceira não encontrado');
                return;
            }

            // Destruir gráfico anterior se existir
            if (window.graficoEvolucaoChart) {
                window.graficoEvolucaoChart.destroy();
                window.graficoEvolucaoChart = null;
            }

            // Organizar dados mensais
            const mesesReceitas = {};
            const mesesCustos = {};

            // Processar vendas (receitas)
            dadosVendas.forEach(v => {
                if (v.data && v.liquido) {
                    const mes = v.data.substring(0, 7); // YYYY-MM
                    mesesReceitas[mes] = (mesesReceitas[mes] || 0) + v.liquido;
                }
            });

            // Processar investimentos (custos)
            dadosInvestimentos.forEach(i => {
                if (i.data && i.valor) {
                    const mes = i.data.substring(0, 7); // YYYY-MM
                    mesesCustos[mes] = (mesesCustos[mes] || 0) + i.valor;
                }
            });

            // Obter todos os meses únicos e ordenar
            const todosOsMeses = [...new Set([...Object.keys(mesesReceitas), ...Object.keys(mesesCustos)])].sort();

            if (todosOsMeses.length === 0) {
                // Criar gráfico vazio se não há dados
                const dataAtual = new Date().toISOString().substring(0, 7);
                todosOsMeses.push(dataAtual);
            }

            // Criar novo gráfico
            window.graficoEvolucaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: todosOsMeses.map(mes => {
                        const [ano, mesNum] = mes.split('-');
                        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                        return `${meses[parseInt(mesNum) - 1]}/${ano}`;
                    }),
                    datasets: [{
                        label: 'Receitas',
                        data: todosOsMeses.map(mes => mesesReceitas[mes] || 0),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Custos',
                        data: todosOsMeses.map(mes => mesesCustos[mes] || 0),
                        borderColor: '#EF4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução Financeira Mensal'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatarMoeda(value);
                                }
                            }
                        }
                    }
                }
            });
        }



        // ✅ SUBSTITUIR a função atualizarGraficoDistribuicaoCustos() existente:
        function atualizarGraficoDistribuicaoCustos() {
            const ctx = document.getElementById('graficoDistribuicaoCustos');
            if (!ctx) {
                console.warn('Elemento graficoDistribuicaoCustos não encontrado');
                return;
            }

            // Destruir gráfico anterior se existir
            if (window.graficoDistribuicaoChart) {
                window.graficoDistribuicaoChart.destroy();
                window.graficoDistribuicaoChart = null;
            }

            // Organizar dados por categoria
            const categoriasMap = {};
            dadosInvestimentos.forEach(inv => {
                if (inv.categoria && inv.valor) {
                    const categoria = inv.categoria.charAt(0).toUpperCase() + inv.categoria.slice(1);
                    categoriasMap[categoria] = (categoriasMap[categoria] || 0) + inv.valor;
                }
            });

            const labels = Object.keys(categoriasMap);
            const data = Object.values(categoriasMap);

            if (labels.length === 0) {
                // Mostrar gráfico vazio se não há dados
                labels.push('Sem dados');
                data.push(1);
            }

            // Criar novo gráfico
            window.graficoDistribuicaoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#10B981', '#3B82F6', '#EF4444', '#F59E0B',
                            '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição de Custos por Categoria'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = formatarMoeda(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }


        function atualizarProgressoMeta() {
            try {
                const faturamento = dadosVendas.reduce((total, venda) => total + (venda.liquido || 0), 0);
                const meta = 1000000; // R$ 1.000.000
                const progresso = Math.min((faturamento / meta) * 100, 100);

                // Elementos do dashboard
                const metaProgressEl = document.getElementById('metaProgress');
                const progressBarEl = document.getElementById('progressBar'); // Header
                const progressBarDashEl = document.getElementById('progressBarDash'); // Dashboard
                const progressoMetaEl = document.getElementById('progressoMeta');
                const percentualMetaEl = document.getElementById('percentualMeta');

                // Atualizar valores monetários
                if (metaProgressEl) metaProgressEl.textContent = formatarMoeda(faturamento);

                // Atualizar barras de progresso (ambas)
                if (progressBarEl) progressBarEl.style.width = `${progresso}%`;
                if (progressBarDashEl) progressBarDashEl.style.width = `${progresso}%`;
                if (progressoMetaEl) progressoMetaEl.style.width = `${progresso}%`;

                // Atualizar percentual
                if (percentualMetaEl) percentualMetaEl.textContent = `${progresso.toFixed(1)}%`;

                console.log(`Meta atualizada: R$ ${formatarMoeda(faturamento)} / R$ ${formatarMoeda(meta)} (${progresso.toFixed(1)}%)`);

            } catch (error) {
                console.error('Erro ao atualizar progresso da meta:', error);
            }
        }


        // ============= FUNÇÕES DE PROJEÇÕES =============

        function calcularCenarios() {
            try {
                const areaTotal = parseFloat(document.getElementById('areaHa')?.value) || 10; // Padrão 10ha

                // Cenário Conservador
                const prodConservador = parseFloat(document.getElementById('prodConservador')?.value) || 15000;
                const precoConservador = parseFloat(document.getElementById('precoConservador')?.value) || 3.50;

                // Taxa de conversão mandioca para farinha (25% é padrão da indústria)
                const taxaConversao = 0.25;
                const receitaConservador = areaTotal * prodConservador * taxaConversao * precoConservador;

                // Cenário Realista
                const prodRealista = parseFloat(document.getElementById('prodRealista')?.value) || 20000;
                const precoRealista = parseFloat(document.getElementById('precoRealista')?.value) || 4.00;
                const receitaRealista = areaTotal * prodRealista * taxaConversao * precoRealista;

                // Cenário Otimista
                const prodOtimista = parseFloat(document.getElementById('prodOtimista')?.value) || 25000;
                const precoOtimista = parseFloat(document.getElementById('precoOtimista')?.value) || 4.50;
                const receitaOtimista = areaTotal * prodOtimista * taxaConversao * precoOtimista;

                // Atualizar resultados
                const receitaConservadorEl = document.getElementById('receitaConservador');
                const receitaRealistaEl = document.getElementById('receitaRealista');
                const receitaOtimistaEl = document.getElementById('receitaOtimista');

                if (receitaConservadorEl) receitaConservadorEl.textContent = formatarMoeda(receitaConservador);
                if (receitaRealistaEl) receitaRealistaEl.textContent = formatarMoeda(receitaRealista);
                if (receitaOtimistaEl) receitaOtimistaEl.textContent = formatarMoeda(receitaOtimista);

                // Atualizar gráfico
                atualizarGraficoProjecoes();

            } catch (error) {
                console.error('Erro ao calcular cenários:', error);
            }
        }


        function calcularExpansao() {
            try {
                const metaFaturamento = parseFloat(document.getElementById('metaFaturamento')?.value) || 1000000;

                // Calcular faturamento médio por hectare baseado nos cenários
                const areaAtual = parseFloat(document.getElementById('areaHa')?.value) || 10;
                const prodMediaPorHa = 20000; // kg/ha - cenário realista
                const precoMedio = 4.00; // R$/kg - cenário realista
                const taxaConversao = 0.25; // 25% de conversão para farinha

                const faturamentoPorHa = prodMediaPorHa * taxaConversao * precoMedio;
                const areaNecessaria = metaFaturamento / faturamentoPorHa;
                const areaAdicional = Math.max(0, areaNecessaria - areaAtual);
                const investimentoAdicional = areaAdicional * 25000; // R$ 25.000 por hectare

                // Calcular tempo estimado (baseado em 2 safras por ano)
                const safrasPorAno = 2;
                const anosNecessarios = Math.ceil(areaNecessaria / (areaAtual * safrasPorAno));
                const tempoMeses = Math.max(12, anosNecessarios * 12);

                // Atualizar campos
                const areaNecessariaEl = document.getElementById('areaNecessaria');
                const investimentoAdicionalEl = document.getElementById('investimentoAdicional');
                const tempoMetaEl = document.getElementById('tempoMeta');

                if (areaNecessariaEl) areaNecessariaEl.value = `${areaNecessaria.toFixed(1)} ha`;
                if (investimentoAdicionalEl) investimentoAdicionalEl.value = formatarMoeda(investimentoAdicional);
                if (tempoMetaEl) tempoMetaEl.value = `${tempoMeses} meses`;

            } catch (error) {
                console.error('Erro ao calcular expansão:', error);
            }
        }


        function atualizarGraficoProjecoes() {
            const ctx = document.getElementById('graficoProjecoes');
            if (!ctx) return;

            // Destruir gráfico existente se houver
            if (window.graficoProjecoesInstance) {
                window.graficoProjecoesInstance.destroy();
            }

            try {
                const areaTotal = parseFloat(document.getElementById('areaHa')?.value) || 10;
                const taxaConversao = 0.25;

                // Calcular receitas dos cenários
                const conservador = areaTotal * 15000 * taxaConversao * 3.50;
                const realista = areaTotal * 20000 * taxaConversao * 4.00;
                const otimista = areaTotal * 25000 * taxaConversao * 4.50;

                window.graficoProjecoesInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Conservador', 'Realista', 'Otimista'],
                        datasets: [{
                            label: 'Receita Anual Projetada (R$)',
                            data: [conservador, realista, otimista],
                            backgroundColor: [
                                'rgba(251, 191, 36, 0.8)',  // Amarelo
                                'rgba(59, 130, 246, 0.8)',  // Azul
                                'rgba(34, 197, 94, 0.8)'    // Verde
                            ],
                            borderColor: [
                                'rgb(251, 191, 36)',
                                'rgb(59, 130, 246)',
                                'rgb(34, 197, 94)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return 'Receita: ' + formatarMoeda(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatarMoeda(value);
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Erro ao atualizar gráfico de projeções:', error);
            }
        }


        // ============= FUNÇÕES UTILITÁRIAS =============

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function formatarData(data) {
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        // Inicializar calculadoras ao carregar
        setTimeout(() => {
            calcularCenarios();
            calcularExpansao();
            calcularTempo();
            atualizarAlertas();
        }, 1000);

        function forcarAtualizacaoCompleta() {
            console.log('Forçando atualização completa do dashboard...');

            // Aguardar um momento para garantir que o DOM está pronto
            setTimeout(() => {
                atualizarDashboard();

                // Atualizar também outros gráficos específicos
                setTimeout(() => {
                    if (typeof atualizarGraficosInvestimentos === 'function') {
                        try {
                            atualizarGraficosInvestimentos();
                        } catch (error) {
                            console.warn('Erro ao atualizar gráficos de investimentos:', error);
                        }
                    }

                    if (typeof atualizarGraficoProducao === 'function') {
                        try {
                            atualizarGraficoProducao();
                        } catch (error) {
                            console.warn('Erro ao atualizar gráfico de produção:', error);
                        }
                    }
                }, 100);
            }, 100);
        }

        // Chamar esta função sempre que dados importantes forem alterados
        // Adicionar esta linha no final das funções: adicionarVenda(), adicionarInvestimento(), adicionarProducao()
        // forcarAtualizacaoCompleta();
    </script>
</body>

</html>
